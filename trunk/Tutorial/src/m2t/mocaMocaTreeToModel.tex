\section{Tree-to-Model Transformation with SDMs}

The next step in the text-to-model transformation is a set of SDMs that transform our tree to an instance of our dictionary metamodel.
Take a look at the overview (Fig.~\ref{fig:moca-overview}) again and try to identify which arrow depicts exactly this \emph{tree-to-model} transformation.
Just a short comment;  all SDMs in this section depict story patterns directly in their story nodes.
Please do not take this as a \emph{best practice}, in fact we actually recommend always extracting story patterns.
It's just easier for the tutorial to fit each SDM on a single page!

\begin{enumerate}
  \item[$\blacktriangleright$]  In the code adapter project \texttt{DictionaryCodeAdapter}, create a \texttt{Trans\-for\-mer} class with the methods and reference to the \texttt{Library} class as depicted in Fig.~\ref{fig:moca-DictionaryCodeAdapter}.
%\usepackage{graphics} is needed for \includegraphics
\begin{figure}[!htbp]
\begin{center}
 \includegraphics[width=0.9\textwidth]{pics/moca/3MocaTreeToModel/DictionaryCodeAdapter}
  \caption{Transformer class with methods for SDMs}
  \label{fig:moca-DictionaryCodeAdapter}
\end{center}
\end{figure}
\item[$\blacktriangleright$]  The first SDM \texttt{transformFolder(Folder)~:Library} (depicted in Fig.~\ref{fig:moca-transformFolder}) creates a corresponding library with shelves for the given folder, delegating the creation of dictionaries to \texttt{transformNode}.
The SDM uses features that we have treated in previous chapters.
Note that the exogenous transformation is specified by simply drag \& dropping in elements from \emph{different} metamodels as required!
All dependencies are automatically added when exporting to Eclipse -- now isn't that as simple as ABC?
%\usepackage{graphics} is needed for \includegraphics
\begin{figure}[!htbp]
\begin{center}
 \includegraphics[width=\textwidth]{pics/moca/3MocaTreeToModel/transformFolderPrintPdf}
  \caption{Transforming the outermost folder into a dictionary}
  \label{fig:moca-transformFolder}
\end{center}
\end{figure}
\item[$\blacktriangleright$] The next SDM, \texttt{transformNode(Node)~:Dic\-tion\-ary} (Fig.~\ref{fig:moca-transformNode}) takes a node, representing a dictionary, and builds up a dictionary object, adding entries appropriately.
It further delegates creation of authors to \texttt{transformAuthor}.
Note how \emph{indices} are used in the story node \texttt{match entry node} to decide, according to convention (how we built the tree), which node in the tree is to be interpreted as content and which as the level of the entry.
%\usepackage{graphics} is needed for \includegraphics
\begin{figure}[!htbp]
\begin{center}
 \includegraphics[width=\textwidth]{pics/moca/3MocaTreeToModel/transformNodePrintPdf}
  \caption{Creating dictionaries from dictionary nodes} 
  \label{fig:moca-transformNode}
\end{center}
\end{figure}
\clearpage
\item[$\blacktriangleright$] To wrap things up, create the last SDM, \texttt{trans\-form\-Author(Node)} as depicted in Fig.~\ref{fig:moca-transformAuthor}.
This SDM checks in \texttt{match author node} if the node with \texttt{index} 1 is \emph{not} an entry.
Again according to convention, this would be an author node which is optional.
If no such node exists we do not create an author and simply return.
If such a node does exist, a further complication is that the author might already be known in the library.
In order to avoid multiple, actually identical authors, the author object variable in \texttt{create author} is set to \texttt{optional} and to \texttt{create}.
\marginpar{\emph{Optional Create}} 

The semantics of \emph{optional create} is the following:  if a match for the object variable with the specified attribute \emph{constraints} is found, it is used.
If no match can be found then the object variable is created and the specified attribute assignments are carried out.

This is exactly how we need to handle authors -- cool right? 
%\usepackage{graphics} is needed for \includegraphics
\begin{figure}[!htbp]
\begin{center}
 \includegraphics[width=\textwidth]{pics/moca/3MocaTreeToModel/transformAuthorPrint}
  \caption{Handling Authors}
  \label{fig:moca-transformAuthor}
\end{center}
\end{figure}

\clearpage
\item[$\blacktriangleright$] As a final step, open \texttt{MocaMain.java} (Fig.~\ref{fig:moca-8-MocaMain}) and edit lines 32 -- 39 as follows:
\begin{verbatim}
// Transform tree-to-model
Transformer transformer = 
  DictionaryCodeAdapterFactory.eINSTANCE.createTransformer();
Library library = transformer.transformFolder(tree);
  
// Save model to file
eMoflonEMFUtil.saveModel(DictionaryLanguagePackage.eINSTANCE, 
  library, "./instances/library.xmi");  
\end{verbatim}
  
Open and inspect the library model using the reflective model browser and note especially the cross-tree references between authors and their dictionaries. 
\end{enumerate}