\newpage
\section{Growing the box}
\genHeader

In this SDM, we shall explicitly specify how our learning box is to be built up. We create a specific pattern that will append new partition elements
to the end of \texttt{Box} which will follow our established movement rules (Fig.~\ref{fig:membox_depiction}) for a \texttt{Card}. This means the new partition
will become the \texttt{next} reference of the absolute last partition, and its \texttt{previous} reference must connect to the absolute first partition in the
box (Fig.~\ref{fig:goal_grow}).

\begin{figure}[htbp]
 	\centering
  	\includegraphics[width=0.7\textwidth]{growBoxNACGoal.pdf}
	\caption{Growing a box by inserting a new partition}
	\label{fig:goal_grow}
\end{figure}
\FloatBarrier

Unfortunately, precise instructions such as these contradict the pattern matcher. We know that, no matter what, a box will always be able to
define first and last partitions. As explained in \hyperlink{sec:emptyPartition}{section 5} however, these will be determined non-deterministically. They will
be chosen at random, and are unlikely to be the actual first and last partitions. How can we guarantee this match to be true?

SDMs provide a declarative means of identifying specific partitions via \emph{Negative Application Conditions}, simply referred to as
\mbox{NAC}s.\footnote{Pronounced $\backslash 'nak \backslash$}\define{NAC}\mbox{NAC}s express structures that are forbidden to exist before or after applying a
transformation rule. In this SDM, the \mbox{NAC} will be a link variable that may not be valid during the pattern match. In the theory of algebraic
graph transformations \cite{EEPT06}, \mbox{NACs} can be complex graphs that are much more general and powerful but in our implementation,\footnote{To be
precise, in CodeGen2 from Fujaba} we only support single negative elements (object or link variables).

As depicted in Fig.~\ref{fig:goal_grow}, to create an appropriate \mbox{NAC} that constrains possible matches, we'll need to check to see if the current matched
pattern has certain `active' link variables. Suppose the targeted last partition has a set \texttt{next} reference. This means it is \emph{not} the absolute
last partition, and so the match becomes invalid. We only want the pattern to insert a new partition when the \texttt{next} link is null. Similarly, if the
targeted first partition has a \texttt{previous} value, the match is invalid. The complete pattern match is therefore made unique through NACs and thus becomes
\emph{deterministic} by construction. In other words, if you \emph{grow} the box with this method, there will always be exactly one first and one last
partition.

Of course, to complete this method we will still need to determine how \emph{many} partitions to add! Since the new size must be calculated depending on the
rest of the partitions currently in the box (partitions usually get bigger) we'll need to call a helper method, \texttt{determineNextSize()}. Due to the
low-level nature of this method however, it will be easier to implement this via \emph{Injections}, rather than an SDM.


Previously,\footnote{See Part II, section 5} we learned how to write handwritten code in an implementation file, then generate
a \emph{partial class} to inject code into the metamodel. Now however, we'll generate and edit a partial class to automatically insert code into the
corresponding Java file, which will then inject it into the metamodel.

\begin{itemize}

\item[$\blacktriangleright$] Go to ``BoxImpl.java'' and, without editing any method signatures there, generate its corresponding injection file by either right
clicking the file in the package explorer or within the editor window (Fig.~\ref{}).

\item[$\blacktriangleright$] A second file should now be placed in the \texttt{injection} folder. Open \texttt{BoxImpl.inject} and notice the
partial class includes every method declaration but (as expected) no implementation code (Fig.~\ref{fig:injection_partialClassBox}).

\begin{figure}[htbp]
    \centering
    \includegraphics[width=1.0\textwidth]{eclipse_injectionBoxImpl}
    \caption{Generated Injection file for \texttt{BoxImpl.java}}
    \label{fig:injection_partialClassBox}
\end{figure}

\item[$\blacktriangleright$] Complete the \texttt{addToStringRep} and \texttt{determineNextSize} methods as specified in Fig.~\ref{code:complete_inject_file}
below.\footnote{Note: To help avoid errors, this text is able to be copied and pasted}

\vspace{0.5cm}

\begin{figure}[htbp]
        \centering
        \begin{lstlisting}[language=Java, keywordstyle={\bfseries\color{purple}}, backgroundcolor=\color{white}]
    @model addToStringRep (Card card) <--

            StringBuilder sb = new StringBuilder();

            if (stringRep == null)
            {
                sb.append("BoxContent: [");

            }
            else
            {
                sb.append(stringRep);
                sb.append(", [");
            }

            sb.append(card.getFace());
            sb.append(", ");
            sb.append(card.getBack());
            sb.append("]");

            stringRep = sb.toString();
    -->

    @model determineNextSize () <--

            return getContainedPartition().size() * 10;
    -->

        \end{lstlisting}
        \caption{Implementation of helper methods as an injection}
        \label{code:complete_inject_file}
    \end{figure}
    \FloatBarrier

\vspace{0.5cm}

\item[$\blacktriangleright$] Right-click the injection file, and rebuild your project by selecting ``eMoflon/Clean and
Build''(Fig~\ref{fig:eclipse_buildFromInjecton}).

\item[$\blacktriangleright$] The helper methods should now be implemented in \texttt{BoxImpl.java}, which can be found under
the ``/gen/LearningBoxLanguage.impl'' package (Fig~\ref{fig:eclipse_updatedBoxImpl}).

\item[$\blacktriangleright$] For additional information on injections, check out Part IV: Miscellaneous. Be sure to also
review the work we completed with injections in Part II: Ecore.

\newpage

\vspace*{2cm}

\begin{figure}[htbp]
    \centering
    \includegraphics[width=\textwidth]{eclipse_buildFromInject}
    \caption{Build the entire project from the injection file}
    \label{fig:eclipse_buildFromInjecton}
\end{figure}

\newpage

\vspace*{2cm}

\begin{figure}[htbp]
    \centering
    \includegraphics[width=\textwidth]{eclipse_updatedBoxImpl}
    \caption{Updated \texttt{BoxImpl.java} file}
    \label{fig:eclipse_updatedBoxImpl}
\end{figure}

\fancyfoot[R]{ $\triangleright$ \hyperlink{growBox vis}{Next [visual]\hspace{0.2cm} } \\ $\triangleright$ \hyperlink{growBox tex}{Next [textual]} }

\end{itemize}


\input{../07_growBox/visGrowBox}

\input{../07_growBox/texGrowBox}
