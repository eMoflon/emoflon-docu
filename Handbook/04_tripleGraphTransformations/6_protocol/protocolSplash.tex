\newpage
\section{Extending the transformation}
\genHeader

% Remember, this is relevant for BOTH specifications.

% \emph{Introduce the problem: four partitions. Integrator doesn't help, what do? Protocol! Explain what went wrong, new rule! Run again, show protocol round
% two, and look! it runs fine.}

% Introduce problem: we want four partitions. Add one - woah, it doesn't work! Let's try the integrator. Doesn't help. Chat about the protocol. Lets implement a
% new rule!
% protocol Splash

% vis rule

% tex rule

% Run it again! It works! BRILLIANT. Show in protocol.

At this point, we now have a working TGG triple to transform a \texttt{Dictionary} into a \texttt{Box} with three \texttt{partition}s, and a \texttt{Box} with
exactly three \texttt{Partition}s into \texttt{Dictionary}. The only potential problem is that a learning box with only three partitions may not be the most
useful studying tool. After all, the more partitions you have, the more practice you'll have with the cards by being quizzed again and again.

Let's try adding a fourth partition to \texttt{source.xmi} and run the TGG again. Given that we have a rule to transform three partitions, it should at least
complete a partial transformation, right? 

\begin{itemize}

\item[$\blacktriangleright$] Add a \texttt{partition3} with one \texttt{card} to your \texttt{source.xmi} so that it resembles
Fig.~\ref{fig:fourthPartitionStart}. Don't set or update the partition's \texttt{previous} attribute yet -- let's first run \texttt{TGGMain} again and find out
if the TGG can handle the extra element.

\begin{figure}[htbp]
\begin{center}
  \includegraphics[width=0.7\textwidth]{eclipse_fillFourthPartition}
  \caption{caption}
  \label{fig:fourthPartitionStart}
\end{center}
\end{figure}

\item[$\blacktriangleright$] An error should appear in the eMolfon console window stating that there was a problem while translating your new partition, but the
forward transformation was still able to finish. In fact, if you open \texttt{source.xmi\_FWD.xmi}, you'll be able to confirm the \texttt{English Numbers
Dictionary} was created and includes the newest card! Let's run the integrator on \texttt{corr\_fwd.xmi} to find out exactly what happened.

\item[$\blacktriangleright$] Starting with the initial \texttt{Box}, you'll notice that if you continue pressing \texttt{alt + right} until the end of the
transformation, the TGG detected it would endlessly continue peforming the same \texttt{BoxToDictionaryRule} candidate check. To avoid creating the infinite
cycle trying to resolve it, it exited the action but still went ahead to \texttt{Question Four : card} and successfully created the \texttt{dictionary} entry
(Fig.~\ref{fig:integrator_debugSuccess}).

\begin{figure}[htb]
\begin{center}
  \includegraphics[width=0.7\textwidth]{eclipse_integratorDebug}
  \caption{caption}
  \label{fig:integrator_debugSuccess}
\end{center}
\end{figure}

\item[$\blacktriangleright$] Let's now try and properly connect \texttt{partition3} to \texttt{box} by updating its \texttt{previous} value to
\texttt{partition0}, and changing \texttt{partition2.next} to \texttt{partition3}. Run \texttt{TGGMain} one more time.

\item[$\blacktriangleright$] It didn't work! The integrator won't help us here, so let's try inspecting the protocol file directly for more details. This will
always be produced in \emph{every} transformation. Therefore, if the integrator ever doesn't work, you will always have THIS file for reference.

\item[$\blacktriangleright$] Screenshot of protocol, explain what went wrong (Dangling edge)

\item[$\blacktriangleright$] To help explain, check out figure~\ref{fig:partition3comparison}. The first transformation (without references) still worked
because \ldots The second one failed however, because the MOSL look-ahead feature detected that there was no way it would be able to resolve the dangling
\texttt{partition2.next} reference, which fujaba does not allow.

\newpage

\begin{figure}[htbp]
 	\centering
   \includegraphics[width=0.7\textwidth]{partition3_noConnections}
   \\ \vspace{1cm}
    \includegraphics[width=0.7\textwidth]{partition3_connections}
 	\caption{Successful and Unsuccessful TGG}
 	\label{fig:partition3comparison}
\end{figure}
\FloatBarrier

\end{itemize}

Let's try adding a new rule to handle this additional structure. While we could keep things simple by extending the existing
\texttt{BoxToDictionaryRule} by connecting a fourth partition, what if we wanted a fith one? A sixth? As you can see, this obviously won't work -- there will
always be the potential for an additional \texttt{n+1}th card in an \texttt{n}-sized box.

It should be noted that while we addressed any partition \texttt{index} greater than 2 in our \texttt{IndexToLevel} implementation
code (anything above 2 would simple be assigned as index 2), that only took care of the attribute, not the actual object. The main goal of this rule will be to
extend the structure of a \texttt{Box} during the forward transformation so that the \texttt{CardToEntry} rule
can be applied to any \texttt{card} found in a fourth, fifth, sixth, or greater \texttt{partition}. We therefore don't need to create any new \emph{correspondence
types}  as the changes will only affect the link variables and \texttt{index} attributes of a few \texttt{partition}s.

\jumpDual{allCards vis}{allCards tex}

\input{../6_protocol/visNewRule}

\input{../6_protocol/texNewRule}

% Not needed? remind users to check out and read the protocol in their syyntaxes for detail or run the integrator.
% \input{../6_protocol/protocolClose}
