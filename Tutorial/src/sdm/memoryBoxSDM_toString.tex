\subsection{A string representation for our memory box}

With the next SDM, we shall create a string representation for a complete memory
box.  To accomplish this, we have to iterate through all cards in all partitions
which involves an inner loop nested in an outer loop.  SDMs support arbitrary nesting
of For Each story nodes via special guards.  In Sec.~\ref{sec:empty} we already
used the \texttt{[end]} edge guard to terminate a loop and, as depicted in
\note{[each time]}
Fig.~\ref{fig:sdm_tostring_1}, an \texttt{[each time]} guard is used to indicate
control flow that is \emph{nested} in the For Each story node and is executed
for each match.

Go ahead and create the SDM for \texttt{Box::toString} till it closely resembles
Fig.~\ref{fig:sdm_tostring_1}.  The first For Each \texttt{ForAllPartitions}
matches all partitions and each partition is used \texttt{[each time]} in
\texttt{ForAllCards} to match all cards.  Note that \texttt{partition} in
\texttt{ForAllCards} is bound  and thus refers to the assigned value determined
in \texttt{ForAllParitions}.  When all cards have been matched,
\texttt{ForAllCards} terminates or \texttt{[end]}s and returns to the outer loop
\texttt{ForAllPartitions}.

\begin{figure}[htbp]
\begin{center}
  \includegraphics[width=\textwidth]{pics/sdmBilder/toString/sdm72}
  \caption{Control flow with nested loops.}  
  \label{fig:sdm_tostring_1}
\end{center}
\end{figure}

To actually do something sensible with each card, double-click the empty
activity node that is taken each time a card is matched and invoke the \texttt{Edit
ActivityNode} dialogue.  Now choose \texttt{printCard} as
the name, and \texttt{StatementNode} as the type of the activity node
(Fig.~\ref{fig:sdm_tostring_2}).
\note{Statement Nodes}
A statement node is used to invoke a method from a class in any package in the
current EA project via a MethodCallExpression.  This way, the method invocation
is represented as an activity node and is guaranteed to be executed at this
point in the control flow. 

\begin{figure}[htbp]
\begin{center}
  \includegraphics[width=0.7\textwidth]{pics/sdmBilder/toString/sdm73}
  \caption{Invoking a method in a \texttt{StatementNode}.}  
  \label{fig:sdm_tostring_2}
\end{center}
\end{figure}

As we have already used a MethodCallExpression in an attribute constraint
(Sec.~\ref{sec:sdm_grow}), go ahead and click the \texttt{Method Call
Expression} tab and invoke the \texttt{printCard} operation on \texttt{helper}
with the current \texttt{card} as its argument (Fig.~\ref{fig:sdm_tostring_3}).

Statement nodes should be used to interact with methods that are
implemented by hand and provide a means of invoking libraries and arbitrary Java
code from SDMs.  Please note that we do not differentiate at this point between
methods that are implemented via an SDM or by hand and thus, statement nodes can
\note{Recursion}
of course be used to invoke other SDMs via a MethodCallExpression.  Most
importantly, this enables \emph{recursion} as the current SDM can be invoked on
\texttt{this} with appropriate new arguments.  

A final point to note is that the
return value of the method is ignored -- statement nodes are therefore best used
for void methods that either have appropriate side effects (e.g. manipulate
their arguments).  We shall learn\clearpage in a few pages how to invoke
methods with non-primitive return values (if a method returns a primitive then it can be
invoked in an attribute constraint as in Sec.~\ref{sec:sdm_grow}).

\begin{figure}[htbp]
\begin{center}
  \includegraphics[width=0.35\textwidth]{pics/sdmBilder/toString/sdm74}
  \caption{Specify a \texttt{MethodCallExpression} in the
  \texttt{StatementNode}.}
  \label{fig:sdm_tostring_3}
\end{center}
\end{figure}

To complete the SDM, retrieve the final string representation from the helper by
returning via a MethodCallExpression in the stop node
(Fig.~\ref{fig:sdm_tostring_4}). 

\begin{figure}[htbp]
\begin{center}
  \includegraphics[width=0.576\textwidth]{pics/sdmBilder/toString/sdm75}
  \caption{Using a \texttt{MethodCallExpression} as a return value.}  
  \label{fig:sdm_tostring_4}
\end{center}
\end{figure}

Take some time to compare and reflect on the complete SDM as depicted in
Fig.~\ref{fig:sdm_tostring_5}.  The idea was to abstract from the actual text
representation of the box and model the necessary traversal of the data
structure.  The helper methods \texttt{printCard} and
\texttt{getStringRep} could, for example, build up a string buffer and return
the final string representation respectively.  While modelling this SDM, we have
seen that for each story nodes can be nested, and have learnt two new uses of
MethodCallExpressions that provide a type safe\footnote{Apart from the literal
expressions used for specifying argument values.} means of invoking methods from
SDMs.

\begin{figure}[htbp]
\begin{center}
  \includegraphics[width=0.7\textwidth]{pics/sdmBilder/toString/sdm76}
  \caption{The complete SDM for \texttt{Box::toString}.}  
  \label{fig:sdm_tostring_5}
\end{center}
\end{figure}

As usual, export, generate code, inspect the generated method implementations
and write some tests.  Just like in Sec.~\ref{sec:sdm_grow}, don't forget to
implement the helper methods!
